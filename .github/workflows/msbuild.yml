# .github/workflows/msbuild.yml
name: MSBuild

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  msbuild:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        configuration: [Release, ReleaseAVX2, ReleaseFreetype, ReleaseFreetypeAVX2, ReleaseTextmode, ReleaseTextmodeAVX2]
        platform: [x64]

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Resolve solution path
        run: |
          if (Test-Path ".\Amalgam.sln") {
            "SOLUTION=.\Amalgam.sln" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
            if (-not $sln) { throw "No .sln found anywhere in repo." }
            "SOLUTION=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
          Write-Host "Using solution: $env:SOLUTION"

      - name: Restore NuGet packages
        run: |
          nuget restore "$env:SOLUTION" -NonInteractive

      - name: Build
        run: |
          msbuild "$env:SOLUTION" /m `
            /p:Platform=${{ matrix.platform }} `
            /p:Configuration=${{ matrix.configuration }} `
            /verbosity:minimal

      - name: List output folder (debug)
        if: always()
        run: |
          if (Test-Path ".\output") {
            Get-ChildItem -Recurse -File .\output | Select-Object FullName, Length | Select-Object -First 200
          } else {
            Write-Host "No ./output folder found."
            Get-ChildItem -Recurse -Filter *.dll | Select-Object -First 50 | ForEach-Object { $_.FullName }
          }

      - name: Upload DLLs
        uses: actions/upload-artifact@v4
        with:
          name: Amalgam-${{ matrix.platform }}-${{ matrix.configuration }}-dll
          path: |
            output\${{ matrix.platform }}\${{ matrix.configuration }}\*.dll
            **\bin\${{ matrix.configuration }}\*.dll
          if-no-files-found: warn

      - name: Upload PDBs
        uses: actions/upload-artifact@v4
        with:
          name: Amalgam-${{ matrix.platform }}-${{ matrix.configuration }}-pdb
          path: |
            output\${{ matrix.platform }}\${{ matrix.configuration }}\*.pdb
            **\bin\${{ matrix.configuration }}\*.pdb
          if-no-files-found: warn

