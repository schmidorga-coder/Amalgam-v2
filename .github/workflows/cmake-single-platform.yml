# .github/workflows/msbuild.yml
name: MSBuild (Windows)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64

jobs:
  build:
    name: Build (${{ env.BUILD_PLATFORM }}, ${{ env.BUILD_CONFIGURATION }})
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~\.nuget\packages
            packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.sln', '**/*.csproj', '**/*.vcxproj', '**/packages.config', '**/*.props', '**/*.targets') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Resolve solution path
        run: |
          # Prefer the expected solution name if it exists.
          if (Test-Path ".\Amalgam.sln") {
            "SOLUTION_PATH=.\Amalgam.sln" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            $sln = Get-ChildItem -Recurse -Filter *.sln | Sort-Object FullName | Select-Object -First 1
            if (-not $sln) { throw "No .sln file found in repo." }
            "SOLUTION_PATH=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
          Write-Host "Using solution: $env:SOLUTION_PATH"

      - name: Restore NuGet
        run: |
          nuget restore "$env:SOLUTION_PATH" -NonInteractive

      - name: Build with MSBuild
        run: |
          msbuild "$env:SOLUTION_PATH" /m `
            /p:Configuration=$env:BUILD_CONFIGURATION `
            /p:Platform=$env:BUILD_PLATFORM `
            /verbosity:minimal

      - name: List produced DLLs (debug)
        if: always()
        run: |
          Get-ChildItem -Recurse -Filter *.dll | Select-Object -First 100 | ForEach-Object { $_.FullName }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: amalgam-v2-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIGURATION }}
          path: |
            **\bin\${{ env.BUILD_CONFIGURATION }}\**
            **\${{ env.BUILD_PLATFORM }}\${{ env.BUILD_CONFIGURATION }}\**
            output\${{ env.BUILD_PLATFORM }}\${{ env.BUILD_CONFIGURATION }}\**
          if-no-files-found: warn
